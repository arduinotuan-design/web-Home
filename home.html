<!DOCTYPE html>
<html lang="vi">
<head>

    <script>
    // B·∫¢O V·ªÜ: Ki·ªÉm tra th·∫ª b√†i ngay l·∫≠p t·ª©c
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        window.location.replace('index.html'); 
    }
</script>


    <link rel="apple-touch-icon" href="">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">





<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">



    
<title>Demo Mobile App T@ Smart</title>
    <style>






/* 2ƒê·ªïi m√†u card t·ª´ tr·∫Øng sang xanh nh·∫°t */
/* KHUNG BAO QUANH C√ÅC THI·∫æT B·ªä */
.card {
    background: transparent !important; /* XO√Å KHUNG TR·∫ÆNG */
    padding: 0;
    margin-bottom: 18px;
    border: none;
    box-shadow: none;
}


/* KHUNG THI·∫æT B·ªä C·ª§ TH·ªÇ (H√¨nh ·∫£nh + N√∫t) 2*/
.device-card { 
    background: transparent !important;
    border-radius: 0;
    padding: 0;
}

/* 3Banner gi·ªõi thi·ªáu s·∫£n ph·∫©m */
.product-banner {
    width: 100%;
    height: 180px; /* ƒê·ªô cao banner */
    background: url('LINK_ANH_CUA_BAN_TAI_DAY') no-repeat center center;
    background-size: cover;
    border-radius: 0px;
    margin-bottom: 15px;
    display: flex;
    align-items: flex-end;
    overflow: hidden;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/*  4*/
.banner-text {
    background: rgba(0, 0, 0, 0.4); /* L√†m t·ªëi nh·∫π l·ªõp n·ªÅn ƒë·ªÉ n·ªïi ch·ªØ */
    color: white;
    width: 100%;
    padding: 8px 15px;
    font-size: 14px;
    font-weight: bold;
    backdrop-filter: blur(2px);
}












:root { 
    --bg: #f0f2f5; 
    --primary: #1a73e8; 
    --on-active: #2ecc71;
    --on-dim: #e8f5e9;
    --off-active: #7f8c8d;
    --off-dim: #f5f5f5;
}
/*11*/
body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 10px;
    padding-bottom: 120px !important;

    background: linear-gradient(
        180deg,#D6E8F5 0%,#D6E8F5 100%
    );
}

.system-sync {
    border: 1.5px solid rgba(255, 255, 255, 0.65); /* vi·ªÅn tr·∫Øng m·ªù */
    border-radius: 2px;
    padding: 12px 14px;
    margin: 10px 0;

    background: rgba(255, 255, 255, 0.15); /* n·ªÅn r·∫•t nh·∫π */
    backdrop-filter: blur(4px);           /* n·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ */
}


/* --- KHU V·ª∞C THI·∫æT B·ªä --- */
.grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

/* H√¨nh ·∫£nh cao r√°o ƒë√∫ng √Ω b·∫°n */
.device-img { 
    width: 100%; 
    height: 130px;        /* C√≥ th·ªÉ tƒÉng nh·∫π ƒë·ªô cao n·∫øu mu·ªën */
    object-fit: cover; 
    border-radius: 2px;  /* Bo g√≥c tr√≤n h∆°n nh√¨n s·∫Ω sang h∆°n */
    display: block;
    margin: 0 auto;
}
/* Ch·ªØ V1, V3... nh·ªè s·∫Øc n√©t */
[id^="name-device-"] { 
    font-size: 12px !important; 
    font-weight: bold; 
    margin-top: 15px !important; /* TƒÉng kho·∫£ng c√°ch v·ªõi h√¨nh */
    margin-bottom: 10px;        /* Kho·∫£ng c√°ch v·ªõi n√∫t b·∫•m b√™n d∆∞·ªõi */
    color: #333; 
    display: block;
}
.btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 5px; }

/* N√∫t b·∫•m g·ªçn, kh√¥ng b·ªã d√†i ngo·∫±ng */
.btn { 
    height: 26px; 
    width: 55px;  /* √âp chi·ªÅu r·ªông nh·ªè l·∫°i cho g·ªçn */
    flex: none;   /* NgƒÉn kh√¥ng cho n√∫t t·ª± gi√£n d√†i ra */
    font-size: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 5px;
    font-weight: bold;
}

/* --- LOGIC M√ÄU S·∫ÆC C≈® C·ª¶A B·∫†N (GI·ªÆ NGUY√äN) --- */
.btn-on { background: var(--on-dim); color: var(--on-active); border-color: var(--on-active); }
.btn-off { background: var(--off-dim); color: var(--off-active); border-color: var(--off-active); }
.active-on { background: var(--on-active) !important; color: white !important; }
.active-off { background: var(--off-active) !important; color: white !important; }

/* --- KH√îI PH·ª§C THANH MENU D∆Ø·ªöI (QUAN TR·ªåNG) --- */
.bottom-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 5px 25px 5px;
    background: #f0f2f5; /* M√†u n·ªÅn tr√πng v·ªõi body nh∆∞ code c≈© */
    z-index: 1000;
}

.nav-item {
    background: white; /* M√†u tr·∫Øng cho c√°c √¥ vu√¥ng */
    width: 22%;
    height: 65px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* T·∫°o ƒë·ªô n·ªïi cho √¥ vu√¥ng */
    cursor: pointer;
    color: #2c3e50;
    transition: 0.2s;
}

.nav-item.active { color: #1a73e8; border: 1.5px solid #1a73e8; }
.nav-item i { font-size: 20px; margin-bottom: 4px; }
.nav-item span { font-size: 10px; font-weight: bold; }

/* C√°c th√†nh ph·∫ßn kh√°c */
.hidden { display: none !important; }
















































        /* T√¨m v√† thay th·∫ø c√°c d√≤ng t∆∞∆°ng ·ª©ng trong :root v√† c√°c class btn */

           /* N√∫t B·∫¨T m·∫∑c ƒë·ªãnh */
       
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        .list-box { border: 1px solid #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px; min-height: 40px; background: #fafafa; }
        .list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; }
        .btn-del { color: red; cursor: pointer; font-weight: bold; padding: 0 10px; }
        .btn-save { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
   
         .device-img:active {
    transform: scale(0.95);
    opacity: 0.8;
}


/* Hi·ªáu ·ª©ng khi ƒë∆∞·ª£c ch·ªçn ho·∫∑c nh·∫•n v√†o */


.nav-item:active {
    transform: scale(0.9);
    background: #e8f0fe;
}


/* Th√™m kho·∫£ng tr·ªëng cu·ªëi trang ƒë·ªÉ kh√¥ng b·ªã menu ƒë√® l√™n n·ªôi dung */
body { padding-bottom: 100px !important; }
   </style>
</head>
<body>


     <div id="page-home">
         <div class="banner-text">
            <i class="fa-solid fa-leaf"></i> H·ªá Th·ªëng T@ Smart - N√¢ng T·∫ßm Cu·ªôc S·ªëng
        </div>
        <div class="product-banner">
        <img src="https://images.unsplash.com/photo-1509395176047-4a66953fd231" 
             style="width: 100%; height: 100%; object-fit: cover; position: absolute;">
        
    </div>

    <div class="card">
        <h3 style="color: #1a73e8; font-weight: 800; margin-bottom: 15px;">
            <i class="fa-solid fa-microchip"></i> ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã
        </h3>
        <div id="device_list" class="grid-container"></div>
    </div>

    
        <div class="card">
            <h3>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã</h3>
            <div id="device_list" class="grid-container"></div>
        </div>

      <div class="system-sync" style="display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <div id="status-indicator" style="width: 12px; height: 12px; background: #95a5a6; border-radius: 50%;"></div>
        <span style="font-weight: 800; font-size: 12px;">H·ªÜ TH·ªêNG</span>
    </div>

    <button onclick="updateStatusOnly()" class="btn-save" style="width: auto; padding: 5px 15px; background: #3498db; font-size: 11px;">
        ƒê·ªíNG B·ªò
    </button>
</div>


        <div class="card">
            <h3>L·ªãch T∆∞·ªõi Lan (V2)</h3>
            <div class="input-group">
                <input type="time" id="v2_t">
                <input type="number" id="v2_d" placeholder="Ph√∫t">
                <button onclick="addV2()" style="padding:0 15px; background:#ddd; border-radius:5px;">+</button>
            </div>
            <div id="v2_list" class="list-box"></div>
           <button class="btn-save" style="background: #2ecc71;" onclick="saveV2(this)">G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI</button>
        </div>

        <div class="card">
            <h3>L·∫≠p l·ªãch ƒê√®n (V0)</h3>
            <select id="v10_id"></select>
            <div class="input-group" style="margin-top:10px;">
                <input type="time" id="v10_on">
                <input type="time" id="v10_off">
                <button onclick="addV10()" style="padding:0 15px; background:#ddd; border-radius:5px;">+</button>
            </div>
            <div id="v10_list" class="list-box"></div>
        </div>

      </div>

     <div id="page-alarm" class="hidden">
        <div class="card" style="text-align: center; position: relative;">
            <div onclick="gotoPage('home')" style="position: absolute; left: 15px; top: 18px; cursor: pointer; color: var(--primary);">
                <i class="fa-solid fa-chevron-left"></i> Quay l·∫°i
            </div>
            <h3 style="font-weight: bold; font-size: 18px; margin-bottom: 20px;">C·∫•u h√¨nh Telegram</h3>
            <hr>
            
            <div style="text-align: left; margin-top: 20px;">
                <label><b>Telegram Token:</b></label>
                <input type="text" id="tg_token" style="width:100%; padding:10px; margin:8px 0 15px; border:1px solid #ddd; border-radius:8px;" placeholder="Bot Token c·ªßa b·∫°n...">
                
                <label><b>Telegram Chat ID:</b></label>
                <input type="text" id="tg_id" style="width:100%; padding:10px; margin:8px 0 15px; border:1px solid #ddd; border-radius:8px;" placeholder="ID ng∆∞·ªùi nh·∫≠n...">
                
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px;">
                    <input type="checkbox" id="tg_active" style="width: 20px; height: 20px;" checked>
                    <label for="tg_active" style="color: blue; font-weight: bold; cursor: pointer;">B·∫≠t th√¥ng b√°o chu√¥ng</label>
                </div>

                <button onclick="saveTelegram()" style="width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 10px;">L∆ØU V√Ä C·∫¨P NH·∫¨T</button>
                <button onclick="clearAllData()" style="width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: bold;">X√ìA T·∫§T C·∫¢ (KHI B√ÄN GIAO M√ÅY)</button>
            </div>
        </div>
    </div>


   <div class="bottom-menu">
        <div class="nav-item active" id="nav-home" onclick="gotoPage('home')">
            <i class="fa-solid fa-house"></i>
            <span>Trang Ch·ªß</span>
        </div>
        <div class="nav-item" onclick="alert('T√≠nh nƒÉng video ƒëang c·∫≠p nh·∫≠t')">
            <i class="fa-solid fa-video"></i>
            <span>Video</span>
        </div>
        <div class="nav-item" id="nav-alarm" onclick="gotoPage('alarm')">
            <i class="fa-solid fa-bell"></i>
            <span>B√°o ƒë·ªông</span>
        </div>
        <div class="nav-item" onclick="logout()">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
            <span>ƒêƒÉng Xu·∫•t</span>
        </div>
    </div>



      
    </div>


   
<div style="width: 100%; max-width: 400px; display: flex; justify-content: center;">
    <button class="btn-save" style="background: #e67e22; margin: 20px 0 40px 0; width: 90%;" onclick="phatWifiConfig()">
        üîÑ ƒê·ªîI M·∫†NG WIFI (PH√ÅT AP)
    </button>
</div>






   



 
<script>

// H√†m chuy·ªÉn trang


//===============================================================








// 12. H√†m chuy·ªÉn trang m∆∞·ª£t m√†
function gotoPage(p) {
    // ·∫®n t·∫•t c·∫£ c√°c trang c√≥ ID b·∫Øt ƒë·∫ßu b·∫±ng "page-"
    document.getElementById('page-home').classList.add('hidden');
    document.getElementById('page-alarm').classList.add('hidden');
    
    // Hi·ªán trang c·∫ßn ƒë·∫øn
    const target = document.getElementById('page-' + p);
    if(target) target.classList.remove('hidden');
    if(event) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    // ƒê·ªïi m√†u icon menu (n·∫øu mu·ªën)
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
}
// 22. H√†m L∆∞u Telegram (G·ª≠i l√™n pin V0 ho·∫∑c pin c·∫•u h√¨nh c·ªßa b·∫°n)
 // H√†m l∆∞u c·∫•u h√¨nh Telegram l√™n Worker Cloud
async function saveTelegram() {
    const token = document.getElementById('tg_token').value.trim();
    const id = document.getElementById('tg_id').value.trim();
    const active = document.getElementById('tg_active').checked ? 1 : 0;
    
    if(!token || !id) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß Token v√† Chat ID");

    // T·∫°o chu·ªói c·∫•u h√¨nh ƒë·ªÉ l∆∞u v√†o Pin V0 tr√™n chip/cloud
    const configStr = `TG:${token}|ID:${id}|ACT:${active}`;
    const url = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(configStr)}&device=${DEVICE_NAME}`;

    try {
        await fetch(url);
        alert("‚úÖ ƒê√£ l∆∞u c·∫•u h√¨nh Telegram th√†nh c√¥ng!");
    } catch (e) {
        alert("‚ùå L·ªói k·∫øt n·ªëi, kh√¥ng l∆∞u ƒë∆∞·ª£c!");
    }
}

// 33 H√†m X√≥a (D√πng khi b√†n giao m√°y)
function clearAllData() {
    if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô t√™n thi·∫øt b·ªã v√† c·∫•u h√¨nh Telegram kh√¥ng?")) {
        localStorage.clear();
        // G·ª≠i l·ªánh x√≥a l√™n Cloud n·∫øu c·∫ßn
        alert("ƒê√£ x√≥a s·∫°ch d·ªØ li·ªáu tr√™n tr√¨nh duy·ªát.");
        location.reload();
    }
}











//===============================================================
// H√†m ƒëƒÉng xu·∫•t chu·∫©n b·∫£o m·∫≠t22
function logout() {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) {
        // X√≥a th·∫ª b√†i
        localStorage.removeItem('isLoggedIn');
        // V·ªÅ trang login (ƒë√£ s·ª≠a ƒë√∫ng t√™n file c·ªßa b·∫°n l√† login.html)
        window.location.replace('index.html');
    }
}


// Th√™m V11 v√†o cu·ªëi danh s√°ch n√†y

const allPins = ["V1", "V3", "V4", "V5", "V6", "V7", "V8", "V9", "V10", "V11", "V12"];
const v10Mapping = {
    "1":"V3", "2":"V4", "3":"V5", "4":"V6", "5":"V7", 
    "6":"V8", "7":"V9", "8":"V10", "9":"V11", "10":"V12" 
};
const idLookup = {"V1":1,"V2":2,"V3":3,"V4":4,"V5":5,"V6":6,"V7":7,"V8":8,"V9":9,"V10":10,"V11":11,"V12":12};



let customNames = {};
let listV2 = [], listV10 = [], listV0 = [];

// --- C·∫§U H√åNH TH√îNG MINH ---

const segment = "1"; // ƒê·ªãnh nghƒ©a s·ªë segment ƒë·ªÉ tr√°nh l·ªói fetch
const WORKER_URL = "https://blynk-token-proxy.tanthanhlttb123.workers.dev";
const DEVICE_NAME = "cay";


const isLocal = false;

//---------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", function() {


    const savedTg = localStorage.getItem('tg_config');
if(savedTg) {
    const cfg = JSON.parse(savedTg);
    document.getElementById('tg_token').value = cfg.token;
    document.getElementById('tg_id').value = cfg.id;
    document.getElementById('tg_active').checked = cfg.active;
}
    // 1. L·∫§Y D·ªÆ LI·ªÜU T·ª™ B·ªò NH·ªö T·∫†M (CACHE)
    let cachedNames = localStorage.getItem('last_config');
    let cachedV2 = localStorage.getItem('v2_list_cache');
    let cachedV10 = localStorage.getItem('v10_list_cache');

    if(cachedNames) customNames = JSON.parse(cachedNames);
    if(cachedV2) listV2 = JSON.parse(cachedV2);
    if(cachedV10) listV10 = JSON.parse(cachedV10);


    
    // 2. V·∫º GIAO DI·ªÜN L·∫¶N ƒê·∫¶U
    renderUI(); 
   // updateStatusOnly();
    // 3. N·∫æU ·ªû NH√Ä (ISLOCAL), L·∫§Y T√äN THI·∫æT B·ªä M·ªöI NH·∫§T T·ª™ ESP32
    if (isLocal) {
        fetch('/get_config?t=' + Date.now()).then(r => r.json()).then(data => {
            if(data && Object.keys(data).length > 0) {
                customNames = data;
                localStorage.setItem('last_config', JSON.stringify(data));
                renderUI(); // V·∫Ω l·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t t√™n m·ªõi
            }
        }).catch(()=>{});
    }

    // 4. ƒê·ªíNG B·ªò TR·∫†NG TH√ÅI N√öT B·∫§M NGAY L·∫¨P T·ª®C KHI V·ª™A M·ªû WEB
    updateStatusOnly();

});
// H√†m l·∫•y th√¥ng b√°o gi·ªçng n√≥i


function renderUI() {
    let h = "";
    allPins.forEach(p => {
        let savedImg = localStorage.getItem('img_' + p);
        let imgSrc = "";
        
        if (savedImg) {
            imgSrc = savedImg; // ∆Øu ti√™n ·∫£nh n√©t trong m√°y
        } else if (isLocal) {
            imgSrc = `/${p.toUpperCase()}.JPG?t=${Date.now()}`; // L·∫•y t·ª´ ESP32 n·∫øu ·ªü nh√†
        }else {
    // D√πng ·∫£nh icon m·∫∑c ƒë·ªãnh thay v√¨ link placeholder b·ªã l·ªói
    imgSrc = "https://cdn-icons-png.flaticon.com/512/628/628283.png"; 
}

        h += `<div class="device-card">
            <img src="${imgSrc}" id="img-tag-${p}"
            class="device-img" 
            onerror="this.src='https://via.placeholder.com/150/cccccc/ffffff?text=No+Image'"
            onclick="uploadImg('${p}')" >
            <span id="name-device-${p}" style="cursor:pointer; font-weight:bold; margin-top:5px; display:block;" onclick="editName('${p}')">
                ${customNames[p] || p} ‚úèÔ∏è
            </span>
            <div class="btn-group">
                <button id="on-${p}" class="btn btn-on" onclick="sendCmd('${p}',1)">B·∫¨T</button>
                <button id="off-${p}" class="btn btn-off" onclick="sendCmd('${p}',0)">T·∫ÆT</button>
            </div>
        </div>`;
    });
    document.getElementById('device_list').innerHTML = h;

    // Load options cho V10
    let opt = "";
    for (let id in v10Mapping) {
        opt += `<option value="${id}">${customNames[v10Mapping[id]] || ("ƒê√®n " + id)}</option>`;
    }
    let v0Select = document.getElementById('v10_id');
    if(v0Select) v0Select.innerHTML = opt;

    document.getElementById('v2_list').innerHTML = listV2.map((x, i) => 
        `<div class="list-item"><span><b>${x.t}</b> - T∆∞·ªõi ${x.d}p</span><span class="btn-del" onclick="removeV2(${i})">‚úñ</span></div>`
    ).join('') || '<div style="color:#ccc;text-align:center">Tr·ªëng</div>';

    // C·∫≠p nh·∫≠t c√°ch hi·ªÉn th·ªã danh s√°ch V10
document.getElementById('v10_list').innerHTML = listV10.map((x, i) => {
    let tenPhong = customNames[v10Mapping[x.id]] || 'ƒê√®n ' + x.id;
    return `
    <div class="list-item" style="display: flex; align-items: center; justify-content: space-between;background: transparent;  margin-bottom: 5px; padding: 8px; border-radius: 5px; border-left: 4px solid var(--primary);">
        <div style="flex: 1;">
            <b style="color:var(--primary)">${tenPhong}:</b> 
            <span style="font-size: 12px;">${x.on} ‚ûî ${x.off}</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="saveSingleV10(${i}, this)" style="background: #2ecc71; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 11px;">G·ª¨I</button>
            
            <span class="btn-del" onclick="removeV10(${i})" style="color: #e74c3c; cursor: pointer; font-weight: bold; padding: 0 5px;">‚úñ</span>
        </div>
    </div>`;
}).join('') || '<div style="color:#ccc;text-align:center">Ch∆∞a c√≥ l·ªãch ƒë∆∞·ª£c t·∫°o</div>';
}

// --- H√ÄM CH·ªåN ·∫¢NH SI√äU N√âT ---
function uploadImg(pin) {
    let input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        let file = e.target.files[0];
        if (!file) return;

        let reader = new FileReader();
        reader.onload = event => {
            let img = new Image();
            img.onload = () => {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');

                // 1. L∆ØU B·∫¢N N√âT V√ÄO LOCALSTORAGE (D√πng cho Web Git)
                let MAX_WEB = 600; 
                let scaleWeb = MAX_WEB / img.width;
                canvas.width = MAX_WEB;
                canvas.height = img.height * scaleWeb;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                let highResData = canvas.toDataURL('image/jpeg', 0.8);
                try {
                    localStorage.setItem('img_' + pin, highResData);
                    document.getElementById('img-tag-' + pin).src = highResData;
                } catch(e) { console.log("B·ªô nh·ªõ ƒë·∫ßy, kh√¥ng th·ªÉ l∆∞u ·∫£nh n√©t"); }

                // 2. N√âN 20KB G·ª¨I ESP32 (Ch·ªâ g·ª≠i khi ·ªü nh√† - isLocal)
                if (isLocal) {
                    let MAX_ESP = 300;
                    let scaleESP = MAX_ESP / img.width;
                    canvas.width = MAX_ESP;
                    canvas.height = img.height * scaleESP;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(blob => {
                        let formData = new FormData();
                        formData.append("image", blob, pin.toUpperCase() + ".JPG");
                        fetch('/upload', { method: 'POST', body: formData });
                    }, 'image/jpeg', 0.5);
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };
    input.click();
}




// C√°c h√†m b·ªï tr·ª£ gi·ªØ nguy√™n
let pendingChecks = {}; // L∆∞u tr·ªØ b·ªô h·∫πn gi·ªù t·ª´ng n√∫t
let clickCounter = 0;   // ƒê·∫øm s·ªë n√∫t ƒëang ƒë∆∞·ª£c b·∫•m ƒë·ªìng th·ªùi

function sendCmd(pin, value) {
    const key = localStorage.getItem('userPass');
    const onBtn = document.getElementById(`on-${pin}`);
    const offBtn = document.getElementById(`off-${pin}`);

    // 1. Ph·∫£n h·ªìi m√†u s·∫Øc t·ª©c th√¨
    if (value === 1) {
        onBtn.className = "btn btn-on active-on";
        offBtn.className = "btn btn-off";
    } else {
        onBtn.className = "btn btn-on";
        offBtn.className = "btn btn-off active-off";
    }

    // 2. Logic t√≠nh th·ªùi gian ch·ªù ƒë√∫ng √Ω b·∫°n
    clickCounter++; // TƒÉng bi·∫øn ƒë·∫øm m·ªói khi b·∫•m
    
    let waitTime = 2000; // M·∫∑c ƒë·ªãnh 2s cho 1 ho·∫∑c 2 n√∫t ƒë·∫ßu
    if (clickCounter > 2) {
        waitTime = 2000 + ((clickCounter - 2) * 500); // T·ª´ n√∫t th·ª© 3 c·ªông th√™m 0.5s
    }

    // X√≥a h·∫πn gi·ªù c≈© c·ªßa n√∫t n√†y n·∫øu c√≥ (ƒë·ªÉ tr√°nh b·ªã tr√πng l·ªánh)
    if (pendingChecks[pin]) clearTimeout(pendingChecks[pin]);

    // 3. G·ª≠i l·ªánh POST
    fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            'action': 'update',
            'pin': pin,
            'value': value,
            'device': DEVICE_NAME,
            'key': key
        })
    }).then(() => {
        // ƒê·∫∑t h·∫πn gi·ªù ki·ªÉm tra tr·∫°ng th√°i th·ª±c t·ª´ chip
        pendingChecks[pin] = setTimeout(() => {
            updateStatusOnly(); 
            
            // Sau khi ki·ªÉm tra xong, gi·∫£m bi·∫øn ƒë·∫øm nh∆∞ng kh√¥ng ƒë·ªÉ √¢m
            clickCounter--;
            if (clickCounter < 0) clickCounter = 0;
            
            delete pendingChecks[pin];
        }, waitTime);
    });
}

// 2. H√†m ƒê·ªîI T√äN thi·∫øt b·ªã (X·ª≠ l√Ω ti·∫øng Vi·ªát c√≥ d·∫•u + Gi·∫•u key)
function editName(p) {
    if (isUpdating) return; 
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi cho " + p + ":", oldName);
    if (!newName || newName === oldName) return;

    isUpdating = true; 
    customNames[p] = newName;
    localStorage.setItem('last_config', JSON.stringify(customNames));
    renderUI();

    const secret = localStorage.getItem('userPass'); // Ch√¨a kh√≥a b√≠ m·∫≠t
    const dataV13 = p + ":" + newName; 
    
    // D√πng encodeURIComponent ƒë·ªÉ b·∫£o v·ªá ti·∫øng Vi·ªát c√≥ d·∫•u
    const encodedValue = encodeURIComponent(dataV13);
    const urlV13 = `${WORKER_URL}?action=update&pin=V13&value=${encodedValue}&device=${DEVICE_NAME}&key=${secret}`;

    fetch(urlV13).then(res => {
        if (res.ok) console.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t t√™n qua Worker");
        isUpdating = false; 
    }).catch(() => { isUpdating = false; });
}
// H√†m n√†y ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t v√† ƒë·ªïi m√†u c√°i ƒë√®n nh·ªè tr√™n thanh tr·∫°ng th√°i


// T·ª∞ ƒê·ªòNG CH·∫†Y KHI M·ªû WEB1
async function saveSingleV10(index, btn) {
    let item = listV10[index];
    if(!item) return;

    // L·∫•y ID th·ª±c t·∫ø (v√≠ d·ª•: V3 l·∫•y s·ªë 3)
    let realId = v10Mapping[item.id].replace("V", "");
    
    // T·∫°o chu·ªói ƒë√∫ng ƒë·ªãnh d·∫°ng Master ƒëang ƒë·ª£i
    let dataStr = `id:${realId} ${item.on} true ${item.off} false`;

    btn.innerText = "‚è≥";
    btn.disabled = true;

    // T√¨m trong h√†m saveSingleV10 d√≤ng n√†y v√† s·ª≠a l·∫°i:
const url = `${WORKER_URL}?action=update&pin=V0&value=${encodeURIComponent(dataStr)}&device=${DEVICE_NAME}&key=${localStorage.getItem('userPass')}`;

    try {
        await fetch(url);
        btn.innerText = "‚úÖ OK";
        btn.style.background = "#95a5a6";
        setTimeout(() => { 
            btn.innerText = "G·ª¨I"; 
            btn.style.background = "#2ecc71";
            btn.disabled = false;
        }, 2000);
    } catch (err) {
        alert("L·ªói k·∫øt n·ªëi!");
        btn.innerText = "TH·ª¨ L·∫†I";
        btn.disabled = false;
    }
}

function addV2() {
    let t = document.getElementById('v2_t').value;
    let d = document.getElementById('v2_d').value;
    if(t && d) {
        if (listV2.length >= 6) return alert("T·ªëi ƒëa 6 l·∫ßn!");
        listV2.push({t, d}); renderUI(); 
    }
    
    
}

function updateStatusOnly() {
    const indicator = document.getElementById('status-indicator');
    if(indicator) indicator.style.background = "#f1c40f"; 
    const key = localStorage.getItem('userPass');

    fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            'action': 'get_all',
            'device': DEVICE_NAME,
            'key': key
        })
    })
    .then(r => r.text())
    .then(text => {
        try {
            if (text.trim().startsWith('{')) {
                const data = JSON.parse(text);
                if(indicator) indicator.style.background = "#2ecc71";
                for (let p in data) {
                    let onBtn = document.getElementById(`on-${p}`);
                    let offBtn = document.getElementById(`off-${p}`);
                    if(onBtn && offBtn) {
                        let val = String(data[p]); 
                        if (val === "1" || val === "true") {
                            onBtn.className = "btn btn-on active-on";
                            offBtn.className = "btn btn-off";
                        } else {
                            onBtn.className = "btn btn-on";
                            offBtn.className = "btn btn-off active-off";
                        }
                    }
                }
            } else {
                if(indicator) indicator.style.background = "#e67e22"; 
            }
        } catch (err) {}
    })
    .catch(e => {
        if(indicator) indicator.style.background = "#e74c3c"; 
    });
}


function saveV2(btn) {
    let full = [];
    for(let i=0; i<6; i++) {
        if(listV2[i]) {
            let p = listV2[i].t.split(':');
            full.push({id:i+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[i].d), a:true});
        } else {
            full.push({id:i+1, h:0, m:0, d:0, a:false});
        }
    }
    localStorage.setItem('v2_list_cache', JSON.stringify(listV2));
    const key = localStorage.getItem('userPass');

    // POST n·ªôi dung y h·ªát b·∫£n GET
    fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            'action': 'update',
            'pin': 'V2',
            'value': JSON.stringify(full),
            'device': DEVICE_NAME,
            'key': key
        })
    }).then((response) => {
        if (response.ok) {
            btn.innerText = "‚úÖ ƒê√É X·ª¨ L√ù!"; 
            btn.style.background = "#2ecc71";
            setTimeout(() => { 
                btn.innerText = "G·ª¨I & L∆ØU L·ªäCH T∆Ø·ªöI"; 
                btn.style.background = ""; 
            }, 2000);
        }
    }).catch(e => {
        console.log("L·ªói m·∫°ng:", e);
    });
}

function addV10() {
    let id = document.getElementById('v10_id').value;
    let on = document.getElementById('v10_on').value;
    let off = document.getElementById('v10_off').value;
    
    if(on && off) {

        if (on === off) {
            alert("‚ö†Ô∏è L·ªói: Gi·ªù B·∫≠t v√† T·∫Øt kh√¥ng ƒë∆∞·ª£c tr√πng nhau!");
            return; // Tho√°t ra lu√¥n, kh√¥ng l∆∞u
        }
        // Ghi ƒë√® n·∫øu tr√πng ID thi·∫øt b·ªã, ho·∫∑c th√™m m·ªõi
        listV10 = listV10.filter(x => x.id !== id);
        listV10.push({id, on, off}); 
        
        // --- QUAN TR·ªåNG: L∆∞u v√†o localStorage ---
        localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
        
        renderUI();
    } else {
        alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß gi·ªù B·∫≠t v√† T·∫Øt!");
    }
}


function removeV2(i) {
    if(confirm("X√≥a l·ªãch?")) { 
        // 1. X√≥a ph·∫ßn t·ª≠ kh·ªèi m·∫£ng listV2 (Logic c≈© c·ªßa b·∫°n)
        listV2.splice(i, 1); 
        
        // 2. V·∫Ω l·∫°i giao di·ªán ngay l·∫≠p t·ª©c
        renderUI(); 
        
        // 3. G·ª≠i m·∫£ng m·ªõi l√™n Cloud ƒë·ªÉ ƒë·ªìng b·ªô (D√πng POST y chang h√†m saveV2)
        const key = localStorage.getItem('userPass');
        let full = [];
        for(let j=0; j<6; j++) {
            if(listV2[j]) {
                let p = listV2[j].t.split(':');
                full.push({id:j+1, h:parseInt(p[0]), m:parseInt(p[1]), d:parseInt(listV2[j].d), a:true});
            } else {
                full.push({id:j+1, h:0, m:0, d:0, a:false});
            }
        }
        // C·∫≠p nh·∫≠t b·ªô nh·ªõ ƒë·ªám
        localStorage.setItem('v2_list_cache', JSON.stringify(listV2));

        // G·ª≠i l·ªánh POST ƒëi
        fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'action': 'update',
                'pin': 'V2',
                'value': JSON.stringify(full),
                'device': DEVICE_NAME,
                'key': key
            })
        }).then(r => {
            console.log("ƒê√£ ƒë·ªìng b·ªô x√≥a l·ªãch V2 l√™n Cloud.");
        });
    }
}
function removeV10(i) {
    let item = listV10[i];
    if(confirm(`X√≥a l·ªãch ${customNames[v10Mapping[item.id]] || 'n√†y'}?`)) {
        let realId = v10Mapping[item.id].replace("V", "");
        let cmdDelete = `id:${realId} DELETE`; 
        const key = localStorage.getItem('userPass'); 

        fetch(WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                'action': 'update',
                'pin': 'V0',
                'value': cmdDelete,
                'device': 'cay',
                'key': key
            })
        }).then(() => {
            listV10.splice(i, 1);
            localStorage.setItem('v10_list_cache', JSON.stringify(listV10));
            renderUI();
        });
    }
}

async function deleteAllSchedules() {
    if (!confirm("‚ö†Ô∏è B·∫°n c√≥ mu·ªën X√ìA T·∫§T C·∫¢ l·ªãch ƒë√®n kh√¥ng?")) return;

    const key = localStorage.getItem('userPass');

    // S·ª¨A T·∫†I ƒê√ÇY: Th√™m &key=${key}
    const deleteUrl = `${WORKER_URL}?action=update&pin=V10&value=CLEAR_DEN&device=cay&key=${key}`;
    
    try {
        const res = await fetch(deleteUrl);
        if(res.ok) {
            alert("‚úÖ ƒê√£ g·ª≠i l·ªánh x√≥a l·ªãch ƒë√®n th√†nh c√¥ng!");
            // X√≥a s·∫°ch d·ªØ li·ªáu t·∫°m tr√™n tr√¨nh duy·ªát
            localStorage.removeItem('savedSchedules'); 
            location.reload(); 
        }
    } catch (err) {
        alert("L·ªói k·∫øt n·ªëi Worker!");
    }
}


let isUpdating = false; 
function editName(p) {
    if (isUpdating) return; 
    
    let oldName = (customNames[p] || p);
    let newName = prompt("T√™n m·ªõi cho " + p + ":", oldName);
    
    // N·∫øu ng∆∞·ªùi d√πng nh·∫•n Cancel ho·∫∑c kh√¥ng ƒë·ªïi t√™n th√¨ tho√°t
    if (!newName || newName === oldName) return;

    isUpdating = true; 

    // 1. C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y nhanh
    customNames[p] = newName;
    localStorage.setItem('last_config', JSON.stringify(customNames));
    renderUI();

    // 2. Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi (V1:T√™n c√≥ d·∫•u)
    const key = localStorage.getItem('userPass'); 
    const dataV13 = p + ":" + newName; 
    
    // QUAN TR·ªåNG: D√πng encodeURIComponent ƒë·ªÉ "b·ªçc" ti·∫øng Vi·ªát l·∫°i cho Worker
    const encodedValue = encodeURIComponent(dataV13);
    const urlV13 = `${WORKER_URL}?action=update&pin=V13&value=${encodedValue}&device=${DEVICE_NAME}&key=${key}`;
    
    console.log(">>> ƒêang g·ª≠i t√™n m·ªõi: " + dataV13);

   console.log(">>> ƒêang g·ª≠i t√™n m·ªõi b·∫±ng POST: " + dataV13);

    fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=update&pin=V13&value=${encodeURIComponent(dataV13)}&device=${DEVICE_NAME}&key=${key}`
    })
    .then(response => {
        if (response.ok) console.log("‚úÖ Th√†nh c√¥ng!");
        isUpdating = false; 
    })
    .catch(err => {
        console.error("‚ùå L·ªói:", err);
        isUpdating = false;
    });
}
function phatWifiConfig() {
    let code = prompt("M√É X√ÅC TH·ª∞C:");
    if (!code) return;
    fetch('/phat_wifi_ap?auth_code=' + encodeURIComponent(code))
    .then(r => r.text()).then(txt => alert(txt)).catch(() => alert("ƒêang chuy·ªÉn ch·∫ø ƒë·ªô..."));
}
////22-1-2026 0H:48Mrrrrrrrrrrrrrrrrrrrrrrr  https://gemini.google.com/app/90ef083a741b66cd
</script>

</body>
</html>
